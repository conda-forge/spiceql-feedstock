From e7b10647c89fb7957dda16c4e1c2afe06c7f2109 Mon Sep 17 00:00:00 2001
From: acpaquette <acpaquette@usgs.gov>
Date: Tue, 12 Aug 2025 14:15:02 -0700
Subject: [PATCH] Addressed json warnings and fixed for current fmt/spdlog
 versions

---
 SpiceQL/src/api.cpp                     |  1 +
 SpiceQL/src/config.cpp                  | 10 +++++-----
 SpiceQL/src/inventoryimpl.cpp           |  2 +-
 SpiceQL/src/query.cpp                   |  2 +-
 SpiceQL/src/spice_types.cpp             |  1 +
 SpiceQL/src/spiceql.cpp                 |  2 +-
 SpiceQL/src/utils.cpp                   |  1 +
 SpiceQL/tests/Fixtures.cpp              |  1 +
 SpiceQL/tests/FunctionalTestsConfig.cpp | 14 +++++++-------
 SpiceQL/tests/MemoTests.cpp             |  1 +
 SpiceQL/tests/QueryTests.cpp            |  1 +
 environment.yml                         |  5 +++--
 12 files changed, 24 insertions(+), 17 deletions(-)

diff --git a/SpiceQL/src/api.cpp b/SpiceQL/src/api.cpp
index f75914d..6c5c90c 100644
--- a/SpiceQL/src/api.cpp
+++ b/SpiceQL/src/api.cpp
@@ -10,6 +10,7 @@
 
 #include <fmt/format.h>
 #include <fmt/compile.h>
+#include <fmt/ranges.h>
 
 #include <nlohmann/json.hpp>
 #include <spdlog/spdlog.h>
diff --git a/SpiceQL/src/config.cpp b/SpiceQL/src/config.cpp
index 5da3b22..d9aeda3 100644
--- a/SpiceQL/src/config.cpp
+++ b/SpiceQL/src/config.cpp
@@ -91,7 +91,7 @@ namespace SpiceQL {
     json::json_pointer pathMod;
     vector<string> deconstructedPointer = {""};
 
-    while (pointer != "") {
+    while (pointer != json::json_pointer("")) {
       deconstructedPointer.push_back(pointer.back());
       pointer.pop_back();
     }
@@ -106,7 +106,7 @@ namespace SpiceQL {
     json::json_pointer fullPointer = pathMod;
 
   // If there is some dependency at the pointer requested, return that instead
-    string depPath = json::json_pointer(getRootDependency(config, fullPointer.to_string()));
+    string depPath = getRootDependency(config, fullPointer.to_string());
     if (depPath != "") {
       return depPath;
     }
@@ -139,11 +139,11 @@ namespace SpiceQL {
       json::json_pointer full_pointer = pointer / json_pointer;
 
       fs::path fsDataPath(dataPath);
-      json::json_pointer kernelPath(getParentPointer(full_pointer, 1));
+      json::json_pointer kernelPath(getParentPointer(full_pointer.to_string(), 1));
       if (fs::exists((string)fsDataPath + kernelPath.to_string())) {
         fsDataPath += kernelPath.to_string();
         kernelPath = json::json_pointer("/kernels");
-        string kernelType = json::json_pointer(getParentPointer(full_pointer, 2)).back();
+        string kernelType = json::json_pointer(getParentPointer(full_pointer.to_string(), 2)).back();
         kernelPath /= kernelType;
         if (fs::exists((string)fsDataPath + kernelPath.to_string())) {
           fsDataPath += kernelPath.to_string();
@@ -174,7 +174,7 @@ namespace SpiceQL {
         pointer = "/" + pointer;
       }
       json::json_pointer p(pointer);
-      res[p] = get(p);
+      res[p] = get(p.to_string());
     }
 
     return res;
diff --git a/SpiceQL/src/inventoryimpl.cpp b/SpiceQL/src/inventoryimpl.cpp
index b0dae6b..43a1cc7 100644
--- a/SpiceQL/src/inventoryimpl.cpp
+++ b/SpiceQL/src/inventoryimpl.cpp
@@ -101,7 +101,7 @@ namespace SpiceQL {
       for(auto &subArr : arr) {
         for (auto &kernel : subArr) {
           pair<double, double> sstimes = getKernelStartStopTimes(kernel);
-          SPDLOG_TRACE("{} times: {}, {}", kernel, sstimes.first, sstimes.second); 
+          SPDLOG_TRACE("{} times: {}, {}", std::string(kernel), sstimes.first, sstimes.second); 
           // use start_time as index to the majority of kernels, then use stop time in the value 
           // to get the final list
           size_t index = 0;
diff --git a/SpiceQL/src/query.cpp b/SpiceQL/src/query.cpp
index 0eadd64..c2f81ef 100644
--- a/SpiceQL/src/query.cpp
+++ b/SpiceQL/src/query.cpp
@@ -12,7 +12,7 @@
 #include <SpiceUsr.h>
 
 #include <ghc/fs_std.hpp>
-#include <spdlog/spdlog.h>
+#include <fmt/ranges.h>
 
 #include <spdlog/spdlog.h>
 
diff --git a/SpiceQL/src/spice_types.cpp b/SpiceQL/src/spice_types.cpp
index 599f693..9cb33a8 100644
--- a/SpiceQL/src/spice_types.cpp
+++ b/SpiceQL/src/spice_types.cpp
@@ -10,6 +10,7 @@
 #include <nlohmann/json.hpp>
 
 #include <ghc/fs_std.hpp>
+#include <fmt/ranges.h>
 
 #include <spdlog/spdlog.h>
 
diff --git a/SpiceQL/src/spiceql.cpp b/SpiceQL/src/spiceql.cpp
index 76a9534..89e8eab 100644
--- a/SpiceQL/src/spiceql.cpp
+++ b/SpiceQL/src/spiceql.cpp
@@ -79,7 +79,7 @@ namespace SpiceQL {
         
         SPDLOG_DEBUG("Using log dir: {}", log_dir); 
         SPDLOG_DEBUG("Log level: {}", log_level_string); 
-        SPDLOG_DEBUG("Log level enum: {}", log_level);
+        SPDLOG_DEBUG("Log level enum: {}", int(log_level));
         SPDLOG_TRACE("Log dir: {}", log_dir);
       } 
     }
diff --git a/SpiceQL/src/utils.cpp b/SpiceQL/src/utils.cpp
index b4c61eb..4fbb2db 100644
--- a/SpiceQL/src/utils.cpp
+++ b/SpiceQL/src/utils.cpp
@@ -19,6 +19,7 @@
 #include <fmt/chrono.h>
 #include <fmt/format.h>
 #include <fmt/compile.h>
+#include <fmt/ranges.h>
 
 #include <nlohmann/json.hpp>
 #include <spdlog/spdlog.h>
diff --git a/SpiceQL/tests/Fixtures.cpp b/SpiceQL/tests/Fixtures.cpp
index d5c2cbc..a79ffa5 100644
--- a/SpiceQL/tests/Fixtures.cpp
+++ b/SpiceQL/tests/Fixtures.cpp
@@ -2,6 +2,7 @@
 #include "Paths.h"
 
 #include <fmt/format.h>
+#include <fmt/ranges.h>
 #include <spdlog/spdlog.h>
 
 #include <exception>
diff --git a/SpiceQL/tests/FunctionalTestsConfig.cpp b/SpiceQL/tests/FunctionalTestsConfig.cpp
index 39a2ade..8ef55ca 100644
--- a/SpiceQL/tests/FunctionalTestsConfig.cpp
+++ b/SpiceQL/tests/FunctionalTestsConfig.cpp
@@ -23,40 +23,40 @@ TEST_F(IsisDataDirectory, FunctionalTestConfigEval) {
   int expected_number = 0;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res["clementine1"][pointer]).size(), expected_number);
   EXPECT_EQ(SpiceQL::getKernelsAsVector(pointer_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig["clementine1"][pointer].size(), 1);
+  EXPECT_EQ(testConfig["clementine1"][pointer.to_string()].size(), 1);
 
   pointer = "/ck/smithed/kernels"_json_pointer;
   expected_number = 1;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res["clementine1"][pointer]).size(), expected_number);
   EXPECT_EQ(SpiceQL::getKernelsAsVector(pointer_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig["clementine1"][pointer].size(), expected_number);
+  EXPECT_EQ(testConfig["clementine1"][pointer.to_string()].size(), expected_number);
 
   pointer = "/spk/reconstructed/kernels"_json_pointer;
   expected_number = 0;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res["clementine1"][pointer]).size(), expected_number);
   EXPECT_EQ(SpiceQL::getKernelsAsVector(pointer_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig["clementine1"][pointer].size(), 1);
+  EXPECT_EQ(testConfig["clementine1"][pointer.to_string()].size(), 1);
 
   pointer = "/fk/kernels"_json_pointer;
   expected_number = 3;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res["clementine1"][pointer]).size(), expected_number);
   EXPECT_EQ(SpiceQL::getKernelsAsVector(pointer_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig["clementine1"][pointer].size(), 1);
+  EXPECT_EQ(testConfig["clementine1"][pointer.to_string()].size(), 1);
 
   pointer = "/sclk/kernels"_json_pointer;
   expected_number = 1;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res["clementine1"][pointer]).size(), expected_number);
   EXPECT_EQ(SpiceQL::getKernelsAsVector(pointer_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig["clementine1"][pointer].size(), 1);
+  EXPECT_EQ(testConfig["clementine1"][pointer.to_string()].size(), 1);
 
   pointer = "/uvvis/ik/kernels"_json_pointer;
   expected_number = 1;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig[pointer].size(), expected_number);
+  EXPECT_EQ(testConfig[pointer.to_string()].size(), expected_number);
 
   pointer = "/uvvis/iak/kernels"_json_pointer;
   expected_number = 4;
   EXPECT_EQ(SpiceQL::getKernelsAsVector(config_eval_res[pointer]).size(), expected_number);
-  EXPECT_EQ(testConfig[pointer].size(), 1);
+  EXPECT_EQ(testConfig[pointer.to_string()].size(), 1);
 }
 
diff --git a/SpiceQL/tests/MemoTests.cpp b/SpiceQL/tests/MemoTests.cpp
index 4161339..bc924af 100644
--- a/SpiceQL/tests/MemoTests.cpp
+++ b/SpiceQL/tests/MemoTests.cpp
@@ -1,6 +1,7 @@
 #include <gtest/gtest.h>
 
 #include <fmt/format.h>
+#include <fmt/ranges.h>
 #include <ghc/fs_std.hpp>
 #include <chrono>
 
diff --git a/SpiceQL/tests/QueryTests.cpp b/SpiceQL/tests/QueryTests.cpp
index 9319111..5f689ea 100644
--- a/SpiceQL/tests/QueryTests.cpp
+++ b/SpiceQL/tests/QueryTests.cpp
@@ -2,6 +2,7 @@
 #include <algorithm>
 
 #include <fmt/format.h>
+#include <fmt/ranges.h>
 #include <gtest/gtest.h>
 #include <spdlog/spdlog.h>
 
diff --git a/environment.yml b/environment.yml
index cdae898..3631dbc 100644
--- a/environment.yml
+++ b/environment.yml
@@ -9,9 +9,9 @@ dependencies:
   - cspice 
   - cxx-compiler
   - doxygen
+  - fmt
   - h5py
   - highfive==2.10.1
-  - fmt==9.1.0
   - libhiredis
   - ninja
   - pip
@@ -31,4 +31,5 @@ dependencies:
     - mkdocs-swagger-ui-tag
     - mkdoxy
     - check-jsonschema
-    - mkdocs-material
\ No newline at end of file
+    - mkdocs-material
+
-- 
2.47.0

